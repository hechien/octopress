<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: notes | 赫謙小便籤]]></title>
  <link href="http://hechien.github.com/octopress/blog/categories/notes/atom.xml" rel="self"/>
  <link href="http://hechien.github.com/octopress/"/>
  <updated>2012-07-04T10:09:59+08:00</updated>
  <id>http://hechien.github.com/octopress/</id>
  <author>
    <name><![CDATA[赫謙]]></name>
    <email><![CDATA[hechien@me.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails 3與Ajax的邂逅]]></title>
    <link href="http://hechien.github.com/octopress/blog/rails3-meets-ajax/"/>
    <updated>2012-07-03T16:01:00+08:00</updated>
    <id>http://hechien.github.com/octopress/blog/rails3-meets-ajax</id>
    <content type="html"><![CDATA[<p>昨天晚上花了一點點時間寫了<a href="http://murmur-coder.herokuapp.com">Murmur Coder</a>，後來加上了Ajax的功能讓發出表單內容後可以不需要重新整理頁面就能夠根據response去顯示畫面。</p>

<p>其實Ajax這種話題應該是已經被講到爛了才對，不過我還是做一下註記好了，畢竟這種方式很Cool ... Rails 把這些東西包在<code>rails.js</code>內了，所以我們可以很簡單的就去實作Ajax的功能。</p>

<p>最近這幾年比較流行的JavaScript寫法似乎是Obtrusive JavaScript，所以我在這邊會簡單的聊一下。</p>

<p>在以往常見的JavaScript寫法，是把一些Event會發生的事件直接寫在HTML Tag上，例如：</p>

<p><code>&lt;p onclick="alert('Hello, world');"&gt;Click me&lt;/p&gt;</code></p>

<p>直接把<code>onclick</code>寫在<code>p</code>標籤內，這種inline的寫法就有點像是直接把CSS寫在<code>style</code>屬性內一樣噁心。之後好像Prototype、jQuery之類的JavaScript framework出來了，因為能夠透過CSS Selector的方式去抓DOM，所以就能夠變成是：</p>

<pre><code>    &lt;p&gt;Click me&lt;/p&gt;
    &lt;script&gt;$('p').click(function(){alert("Hello, world");})&lt;/script&gt;
</code></pre>

<p>這種把HTML與JavaScript分離的作法就叫做Obtrusive JavaScript，讓JavaScript隱藏在某個角落內，使HTML、JavaScript能夠各司其職。</p>

<p>回到我們的主題，就因為Obtrusive JavaScript的概念，所以Rails在整合Ajax的時候十分容易。</p>

<p>我們來看看如何修改<code>form_for</code>吧 ... 假設原本是 <code>form_for @murmur do |form|</code> 的話，就變成是： <code>form_for(@murmur, remote: true) do |form|</code> ... 剩下的Rails已經幫你搞定了</p>

<p>不過開始測試時會發現：「那我要怎樣處理Callback？」、「錯誤咧？怎麼辦啊？」</p>

<p>嘖嘖，這個時候就是交給<code>rails.js</code>來處理囉 ... <code>rails.js</code> 中提供了四個Callback function：</p>

<ul>
<li><code>ajax:beforeSend</code>: 用於在送出之前的狀態</li>
<li><code>ajax:success</code>: 用在執行成功的狀態，基本上Response status code為200, 201等都會進來這邊</li>
<li><code>ajax:complete</code>：不論結果，只要Request執行結束就會跑來這邊，適合重設表單等工作</li>
<li><code>ajax:error</code>：當遇到錯誤的時候會顯示這邊，像是Status code為4xx, 5xx時就會跑來這邊了</li>
</ul>


<p>因為我是直接寫CoffeeScript的，所以我就直接貼CoffeeScript code</p>

<p>{ gist 3018510 murmurs.js.coffee }</p>

<p>簡單的說，就是<code>bind</code>住那四個callbacks就好。只不過在Controller中要記住的就是，如果response content type不是HTML的話，可能會進不了success，這點要注意一下 ....</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Devise與Omniauth實作Facebook自定callback回傳]]></title>
    <link href="http://hechien.github.com/octopress/blog/facebook-oauth-custom-callback-with-devise-and-omniauth/"/>
    <updated>2012-06-19T14:21:00+08:00</updated>
    <id>http://hechien.github.com/octopress/blog/facebook-oauth-custom-callback-with-devise-and-omniauth</id>
    <content type="html"><![CDATA[<p>在測試OAuth登入的時候，新浪與Twitter都會原封不動的把原本傳過去的網址(包含Querystring)一起傳回到Callback網址上，可是Facebook不管怎樣就是辦不到，害我沒辦法讓Mobile Safari收到Callback後Redirect到指定的App去。</p>

<p>原本以為是Omniauth中我有參數沒設到，或者是Facebook設定不對，但是一直trace code卻什麼都沒發現，只好退而求其次，用別的方式去硬幹這部份。</p>

<p>我的作法是，先到 <code>config/routes.rb</code> 去硬刻一個route給Facebook這種不會把Querystring跟著弄回來的Providers用，所以如下</p>

<p><div><script src='https://gist.github.com/2952624.js?file=routes.rb'></script>
<noscript><pre><code>devise_controllers = {
  omniauth_callbacks: &quot;users/omniauth_callbacks&quot;
}
devise_scope :user do
  get 'logout' =&gt; 'devise/sessions#destroy'
  get '/users/auth/:provider/callback/:url_identify' =&gt; 'users/omniauth_callbacks#passthru'
end
devise_for :users, {controllers: devise_controllers}</code></pre></noscript></div>
</p>

<p>然後在App端這邊發送Request的時候就必須從 <code>http://host/users/auth/facebook?url_identify=xxx</code> 改成 <code>http://host/users/auth/facebook/callback/xxx</code> 了。</p>

<p>然後在 <code>omniauth_callbacks_controller.rb</code> 中手動加入 <code>passthru</code> 這個 action</p>

<p><div><script src='https://gist.github.com/2952624.js?file=omniauth_callbacks_controller.rb'></script>
<noscript><pre><code>def passthru
  session[:url_identify] = nil
  session[:url_identify] = params[:url_identify].to_s
  redirect_to &quot;/users/auth/#{params[:provider]}&quot;
end</code></pre></noscript></div>
</p>

<p>這樣子在指定的provider action中就能正常吃到url_identify了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[實作Drag and Drop上傳方式，傳到Rails + Paperclip]]></title>
    <link href="http://hechien.github.com/octopress/blog/how-to-implement-drag-and-drop-upload-with-rails-and-paperclip/"/>
    <updated>2012-06-18T10:28:00+08:00</updated>
    <id>http://hechien.github.com/octopress/blog/how-to-implement-drag-and-drop-upload-with-rails-and-paperclip</id>
    <content type="html"><![CDATA[<p>終於搞出來了 ... 我的媽呀，基礎知識全部忘掉就是了 ... 丟臉</p>

<p>Okay ... 記錄一下實作，不過怎樣用Rails建立Paperclip上傳機制這部份我就不多說了</p>

<p>主要是這段JavaScript code</p>

<p><div><script src='https://gist.github.com/2937600.js?file=uploader.js'></script>
<noscript><pre><code>      $(document).bind('drop', function(e){
        e.preventDefault();
        e.stopPropagation();
        upload(e.originalEvent.dataTransfer.files);
      }).bind('dragenter dragover', function(e){
        e.preventDefault();
        e.stopPropagation();
      });

      var upload = function(files){
        if(typeof(FormData) != 'undefined'){
          var form = new FormData();
          form.append('path', '/');
          for(i = 0; i &lt; files.length; i++){
            form.append('assets[][asset]', files[i]);
          }

          $.ajax({
            url: '/assets/upload_by_drag_and_drop',
            data: form,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function(data){
              console.log(data);
            }
          });
        }
      }</code></pre></noscript></div>
</p>

<p>還有這段Rails code</p>

<p><div><script src='https://gist.github.com/2937600.js?file=upload_by_drag_and_drop.rb'></script>
<noscript><pre><code>assets = params[:assets]
assets.each do |asset|
  Asset.create(asset)
end</code></pre></noscript></div>
</p>

<p>是的，就只有這樣，哈</p>

<p>正在想著把這個部分再用jQuery封裝得好看一點 ...</p>

<p>其實很簡單，就是JavaScript吃到drop event的時候，把收集到的檔案資訊整理起來，用FormData封裝，然後送到後台去這樣。</p>

<p>因為用到XMLHttpRequest，所以乾脆用jQuery來跑好了</p>

<p>註：drop事件、FormData似乎都是HTML 5後才有support的功能，而且不是每個Browser都有Support，所以記得還是得實作傳統的上傳機制 ...</p>

<p>UPDATED: 2012/06/16 02:25 --</p>

<p>已經更改成用jQuery的ajax來上傳了，這樣就省得再用XMLHttpRequest了</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Rails中如何重新設定counter_cache的值？]]></title>
    <link href="http://hechien.github.com/octopress/blog/how-to-reset-counter-cache-in-rails-3/"/>
    <updated>2012-06-18T10:25:00+08:00</updated>
    <id>http://hechien.github.com/octopress/blog/how-to-reset-counter-cache-in-rails-3</id>
    <content type="html"><![CDATA[<p>Rails中有一個<code>counter_cache</code>可以用，這東西的用途就是破壞正規化的(XD) ...</p>

<p>一般來說，當我們要計算關連的資料有幾筆的話，我們會用 <code>SELECT COUNT(id) FROM</code>comments<code>WHERE</code>post_id<code>= 1</code> 這種方式來計算，可是如果當request 量一大且資料量也大的時候這樣子其實超級麻煩的，所以可以透過<code>counter_cache</code>來直接cache住關連的資料筆數。</p>

<p>但是有時候可能因為某些原因導致沒有正確記錄到cache值，這時候我們就可以用<code>reset_counters</code>來自動重新整理這些值 ...</p>

<p>也許你會覺得奇怪，為什麼不要直接把值寫入<code>comments_count</code>這種欄位內就好呢？那是因為 .... 這個值是readonly的囧！</p>

<p>為了保護欄位值的正確只好這樣做，所以我們只好用<code>reset_counters</code>來處理這個部分了。</p>

<p>使用的方式是 <code>Model.reset_counters(id, association_name)</code></p>

<p>若以上面的例子來說的話，就是 <code>Post.reset_counters(1, :comments)</code></p>

<p>如何？很簡單吧？</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Subdomain時自定Devise的Mailer Template]]></title>
    <link href="http://hechien.github.com/octopress/blog/custom-devise-mailer-template-with-subdomain/"/>
    <updated>2012-06-05T17:03:00+08:00</updated>
    <id>http://hechien.github.com/octopress/blog/custom-devise-mailer-template-with-subdomain</id>
    <content type="html"><![CDATA[<p>這問題其實也是忽然間被雷到 ... 在這樣做之前要先去修改 <code>config/initializers/devise.rb</code>，設定自定的Mailer，然後我們還要自己手動產生一個Mailer。</p>

<!-- more -->


<p>我原本的作法是用Namespace來寫整個站，所以View的分類就是已經有分好資料夾了，我直接貼code可以嗎XD</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="sx">%w&#39;confirmation_instructions reset_password_instructions unlock_instructions&#39;</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="o">|&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;define_method &quot;</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="sr">&quot; do |record|</span>
</span><span class='line'><span class="sr">  send_mail_with_record_and_action(record, method.to_s)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="kp">private</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  def send_mail_with_record_and_action(record, action)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">initialize_from_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span class='line'><span class="n">headers</span> <span class="o">=</span> <span class="n">headers_for</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'><span class="n">headers</span><span class="o">[</span><span class="ss">:template_path</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">record</span><span class="o">.</span><span class="n">from_app</span><span class="si">}</span><span class="s2">/mailer&quot;</span>
</span><span class='line'><span class="n">mail</span> <span class="n">headers</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>由於devise有<code>confirmation_instructions</code>、<code>reset_password_instructions</code>、<code>unlock_instructions</code>三個，而我只是要導到不同的app目錄去，所以就這樣子refactor，讓headers中的<code>template_path</code>可以是自訂的目錄。</p>
]]></content>
  </entry>
  
</feed>

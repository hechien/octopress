
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>Rails based on Unicorn + Nginx on Ubuntu Linux @ Linode - 赫謙小便籤</title>
    <meta name="author" content="赫謙">

    
    <meta name="description" content="Rails Based on Unicorn + Nginx on Ubuntu Linux @ Linode 這篇文章是從原本「赫謙隨筆(Posterous)」中轉過來的，所以內文是一樣的。 最近在配置公司主機，其實說真的好像在自討苦吃一樣，在推薦Linode之前原本也考慮過AWS， &hellip;">
    
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

    <link href="http://feeds.feedburner.com/hechienstickies" rel="alternate" title="赫謙小便籤" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/octopress/favicon.png" rel="shortcut icon">
    <link href="/octopress/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="/octopress/javascripts/html5.js"></script><![endif]-->
    <script src="/octopress/javascripts/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9528313-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<header class="inner"><h1 class="left"><a href="/octopress/">赫謙小便籤</a></h1>
<nav class="menu left"><ul class="main">
	<li><a href="/octopress/">Blog</a></li>
	<li><a href="/octopress/blog/archives">Archives</a></li>
</ul>
</nav>
<div class="right">
	<form class="search right" action="http://google.com/search" method="get">
		<input class="left" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:hechien.github.com/octopress">
	</form>
	<div class="social right">
		
		
		
		<a class="twitter" href="http://twitter.com/HeChian" title="Twitter">Twitter</a>
		
		
		<a class="rss" href="http://feeds.feedburner.com/hechienstickies" title="RSS">RSS</a>
		
	</div>
</div>
</header>
	
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/HeChian">HeChian</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="/octopress/javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('HeChian', 5);
	})(jQuery);
</script>

	<div id="content" class="inner"><article class="post">
    <h1 class="title">Rails Based on Unicorn + Nginx on Ubuntu Linux @ Linode</h1>
    <div class="entry"><p>這篇文章是從原本「赫謙隨筆(Posterous)」中轉過來的，所以內文是一樣的。</p>

<!-- more -->


<p>最近在配置公司主機，其實說真的好像在自討苦吃一樣，在推薦Linode之前原本也考慮過AWS，但是因為不熟所以不敢去碰只好選了Linode &#8230; 而且Linode其實也不錯就是了:P</p>

<p>Okay，閒話休提，我來講講配置這整個環境的主要流程一下 &#8230; 我選的是Linode 1024方案(記憶體配1023 MB給我是哪招？)，一開始用32bit的系統但覺得好像效能有點差，所以後來重切硬碟裝上Ubuntu 11 64bit的系統 &#8230; (結果記憶體吃更大囧&#8221;)</p>

<p>總之，先選好你要的Linux OS，然後根據XDite的Rails 101看Ubuntu配置，不過phpMyAdmin那邊可以跳過不看，passenger也不必裝，這邊用的是Nginx + Unicorn。</p>

<p>記得，不要用apt-get的方式安裝nginx，所以直接上 nginx.org 抓最新stable的版本下來，然後根據這段configure參數來編譯</p>

<figure class='code'><figcaption><span>nginx configure with arguments </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./configure   --prefix=/usr   --conf-path=/etc/nginx/nginx.conf   --pid-path=/var/run/nginx.pid   --lock-path=/var/lock/nginx.lock   --http-log-path=/var/log/nginx/access.log   --error-log-path=/var/log/nginx/error.log   --http-client-body-temp-path=/var/lib/nginx/body   --http-proxy-temp-path=/var/lib/nginx/proxy   --http-fastcgi-temp-path=/var/lib/nginx/fastcgi   --http-uwsgi-temp-path=/var/lib/nginx/uwsgi   --http-scgi-temp-path=/var/lib/nginx/scgi   --with-http_ssl_module   --with-http_stub_status_module   --user=nginx   --group=nginx   --without-mail_pop3_module   --without-mail_imap_module   --without-mail_smtp_module --with-http_gzip_static_module; make && make install</span></code></pre></td></tr></table></div></figure>


<p>如果你有什麼要調整的再自己去調整，然後編譯完nginx後我們就可以裝unicorn了，裝unicorn就gem i unicorn就好。</p>

<p>關於nginx的設定，可以上網找找，我這邊大多是用預設值的，而虛擬主機的部分看底下設定檔</p>

<figure class='code'><figcaption><span>nginx conf </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upstream demoapp {
</span><span class='line'>  server unix:/tmp/app.sock fail_timeout=0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>  listen 80;
</span><span class='line'>
</span><span class='line'>  root /path/to/app/current/public;
</span><span class='line'>  server_name app.domain.com;
</span><span class='line'>  access_log /var/log/nginx/app-access.log;
</span><span class='line'>  error_log /var/log/nginx/app-error.log;
</span><span class='line'>  rewrite_log on;
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    proxy_redirect off;
</span><span class='line'>    proxy_set_header Host $http_host;
</span><span class='line'>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>
</span><span class='line'>    if (!-f $request_filename) {
</span><span class='line'>      proxy_pass http://demoapp;    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  location ~* (stylesheets|javascripts|images) {
</span><span class='line'>    if (!-f $request_filename) {
</span><span class='line'>      break;
</span><span class='line'>    }
</span><span class='line'>    if ($query_string ~* "^[0-9]{10}$") {
</span><span class='line'>      expires max;
</span><span class='line'>      break;
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  error_page 500 502 503 504 /500.html;
</span><span class='line'>  location = /500.html {
</span><span class='line'>    root /path/to/app/current/public;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>因為我會用Capistrano來deploy，所以路徑最後一定是 current/public ，建議不要想要去改預定的東西，那只是找麻煩而已 &#8230;</p>

<p>之後存檔離開，我們要把這個虛擬主機檔案丟在 /etc/nginx/sites-avaliable 底下，然後</p>

<p><code>ln -s /etc/nginx/sites-avaliable/demoapp /etc/nginx/sites-enabled/</code></p>

<p>下個指令</p>

<p><code>$ service nginx restart</code></p>

<p><code>restart nginx</code>沒有用 &#8230; 或者<code>/etc/init.d/nginx restart</code>也可以</p>

<p>到此，nginx的設定就搞定了，我們就可以做其他的東西了 &#8230;</p>

<p>記得，deploy千萬不要用root哦，哪天被打到哭了不要說我沒有講 &#8230; =.=</p>

<p>切換到負責deploy的身分上(記得這身分不要給sudoer permission)，然後在家目錄開一個資料夾叫做 configs，建立兩個檔案: database.yml.production 跟 database.yml.production.demoapp</p>

<p>會這樣做是因為database.yml.production可以拿來當skel檔案，有新的app的時候只要copy過去修改內容即可 &#8230;</p>

<p>接著在本地端在config中新增一個unicorn.rb</p>

<figure class='code'><figcaption><span>unicorn.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">app_root</span> <span class="o">=</span> <span class="s2">&quot;/root/path/of/app&quot;</span>
</span><span class='line'><span class="n">app_name</span> <span class="o">=</span> <span class="s2">&quot;demoapp&quot;</span>
</span><span class='line'><span class="n">listen</span> <span class="s2">&quot;/tmp/app.sock&quot;</span><span class="p">,</span> <span class="ss">:backlog</span> <span class="o">=&gt;</span> <span class="mi">2048</span> <span class="c1">#這邊要跟nginx虛擬主機檔中upstream內定義的務必一樣</span>
</span><span class='line'><span class="n">worker_processes</span> <span class="mi">4</span> <span class="c1">#看情況開</span>
</span><span class='line'><span class="n">preload_app</span> <span class="kp">false</span>
</span><span class='line'><span class="n">timeout</span> <span class="mi">30</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span><span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">root</span>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">3</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">_working_directory</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app_root</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">working_directory</span> <span class="n">_working_directory</span>
</span><span class='line'><span class="n">logs_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">_working_directory</span><span class="si">}</span><span class="s2">/log&quot;</span>
</span><span class='line'><span class="n">pid</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">_working_directory</span><span class="si">}</span><span class="s2">/tmp/pids/unicorn.pid&quot;</span>
</span><span class='line'><span class="n">stderr_path</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">logs_path</span><span class="si">}</span><span class="s2">/unicorn.stderr.log&quot;</span>
</span><span class='line'><span class="n">stdout_path</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">logs_path</span><span class="si">}</span><span class="s2">/unicorn.stdout.log&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">GC</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:copy_on_write_friendly</span><span class="o">=</span><span class="p">)</span> <span class="ow">and</span> <span class="no">GC</span><span class="o">.</span><span class="n">copy_on_write_friendly</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">before_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
</span><span class='line'>  <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span> <span class="ow">and</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">disconnect!</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">old_pid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/tmp/pids/unicorn.pid.oldbin&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">old_pid</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="no">Process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&quot;QUIT&quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ESRCH</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Send &#39;QUIT&#39; signal to unicorn error!&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">after_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
</span><span class='line'>  <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span> <span class="ow">and</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>存檔離開，扔入git並且push過後就可以準備deploy了，deploy搞定之後基本上就成功了 &#8230;.</p>

<p>這邊講得很簡陋，不過因為是公司的主機的關係，所以我一定得講得很簡陋XD
不過大致上的流程都講完了，就也只是這樣子而已 &#8230; 下一篇再來講怎樣透過Capistrano去Deploy &#8230;</p>

<p>最近Github釋出了Hubot，我也還沒有時間去看呢 &#8230; 有人要分享怎樣做嗎XDDD</p>

<p>之後我會再貼上我配置主機的方式，希望有人願意share心得一起交流</p>
</div>
    <div class="meta">
        <div class="date">








  


<time datetime="2012-02-03T23:42:00+08:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2012</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/octopress/blog/categories/deploy/'>deploy</a>, <a class='category' href='/octopress/blog/categories/linode/'>linode</a>, <a class='category' href='/octopress/blog/categories/notes/'>notes</a>, <a class='category' href='/octopress/blog/categories/rails/'>rails</a>, <a class='category' href='/octopress/blog/categories/ubuntu/'>ubuntu</a>, <a class='category' href='/octopress/blog/categories/unicorn/'>unicorn</a>
  
</div>

</div>
        
    </div>
</article>
<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
	<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-4eb4a0c47196e907"></script>
</div>

<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer class="inner">Copyright &copy; 2012 赫謙小便籤</footer>
	<script src="/octopress/javascripts/jquery.easing.1.3.js"></script>
<script src="/octopress/javascripts/jquery.fancybox.pack.js"></script>
<script src="/octopress/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'hechienstickies';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://hechien.github.com/octopress/blog/2012/02/03/rails-based-on-unicorn-plus-nginx-on-ubuntu-linux-at-linode/';
        var disqus_url = 'http://hechien.github.com/octopress/blog/2012/02/03/rails-based-on-unicorn-plus-nginx-on-ubuntu-linux-at-linode/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>
</html>